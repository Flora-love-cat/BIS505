---
title: "Lab Assignment 5 BIS 505b"
author: "Wenxin Xu" 
date: "4/11/2021"
output:
  html_document:
    toc: yes
    highlight: default
  pdf_document:
    toc: yes
---

<!--- Copyright (c) 2021, M. Ciarleglio --->

<!--- Set global options that apply to every code chunk in this file, can be overwritten in individual chunk headers --->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
# options(scipen=999)             # global option that requests no scientific notation in this session (*optional*)
options(show.signif.stars=FALSE)  # global option to hide significance stars (*optional*)
```

<!--- Load packages (previously installed)  --->
```{r, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(car)
```

<!--- Set WD and read data file --->
```{r, include=FALSE}
setwd("/Users/xuwenxin/Desktop/BIS 505/Assignments/Lab Assignments")    # set working directory
nets <- read.csv("nets.csv")

```


# Instructions

This Lab Assignment uses data from a study conducted to investigate factors related to insecticide-treated bed net (ITN) use in sub-Saharan Africa. You may keep the sections on **Public Health Application**, **Data Background** and **Data Key** in your submission if you wish. Perform your work in the **Assignment** section below. In this assignment, report any p-values that are less than 0.001 as **<0.001** and round values reported in your narrative text to **3** decimal places. **Be sure to clearly state the reference category when interpreting the effects of categorical variables in any regression model.** Perform all hypothesis testing at the $\alpha$ = 0.05-level.


# Public Health Application

Malaria represents about 1.4% of the global burden of disease, and in Africa, it is the primary cause of disease burden as measured by Disability Adjusted Life Years (DALY) lost. The continent bears over 90% of the global burden of about 2.7 million deaths attributable to malaria and houses over 300 million people who suffer from this disease yearly, the worst hit being young children and pregnant women. More than three quarters of global malaria deaths occur in children under 5-years of age living in malarious countries in sub-Saharan Africa, where 25% of all childhood mortality below the age of 5 is attributable to malaria.   


# Data Background

Insecticide-treated bed nets (ITNs) are a form of personal protection that has been shown to reduce malaria illness, severe disease, and death due to malaria in endemic regions. In community-wide trials in several African settings, ITNs were shown to reduce the death of children under 5 years from all causes by about 20%.^[https://www.cdc.gov/malaria/malaria_worldwide/reduction/itn.html] To investigate factors related to ITN use, a cross-sectional study was conducted. In the study, a survey was given to the head of the household in a tropical region where malaria is a public health problem.  Households (n = 1418) in a tropical region owning an insecticide-treated net were sampled and asked whether the ITN had been used the previous night. The head of the household answered a questionnaire that asked about the age of the head of household [`age`], household wealth [`wealth`], whether there was a child younger than 5 years old residing in the household [`child`], whether the household was located in a rural or urban area [`rural`], the family size in the household [`famsize`], the type of roof for the household [`roof`], and the distance to health care facility [`hcdist`].  All questionnaires were completed with an interviewer and were conducted during the rainy season. The primary goal of this study was to understand the factors associated with using insecticide-treated nets. The primary outcome is whether an ITN was used on the previous night [`net`]. A CSV file [`nets.csv`] is provided which contains data from the households in the study.  


# Data Key â€“ `nets.csv`


| Variable Name	| Definition |
|---------------|------------|
|`ID`	      | Unique identifier for each household |
|`famsize`  | Size of the family (including head of household) |
|`age`      | Age of head of household |
|`rural`    | Rural household |
|           | &nbsp; 0 = Urban (reference) | 
|           | &nbsp; 1 = Rural |
|`hcdist`   | Distance to health care facility |
|           | &nbsp; 1 = <15 miles (reference) |
|           | &nbsp; 2 = 15-50 miles | 
|           | &nbsp; 3 = 50+ miles | 
|`child`    | Household has children under the age of 5 years |
|           | &nbsp; 0 = No (reference)| 
|           | &nbsp; 1 = Yes |
|`wealth`   | Wealth index of household |
|           | &nbsp; 1 = Lowest quartile (reference) |
|           | &nbsp; 2 = Second quartile | 
|           | &nbsp; 3 = Third quartile | 
|           | &nbsp; 4 = Highest quartile | 
|`roof`	    | Type of roof |
|           | &nbsp; 0 = Corrugated metal (reference) |
|           | &nbsp; 1 = Thatched |
|`net`    	| ITN use the previous night |
|           | &nbsp; 0 = No ITN use | 
|           | &nbsp; 1 = ITN use (event of interest)|


# Assignment


**1.** <span style="color: #CC0000;">[5 points]</span> Import the CSV file `nets.csv` in the third code chunk above. Name your data frame `nets` and create the factor variables `rural_factor` (reference = "Urban"), `hcdist_factor` (reference = "<15 miles"), `child_factor` (reference = "No"), `wealth_factor` (reference = "Lowest quartile"), `roof_factor` (reference = "Corrugated metal"), and `net_factor` ("success" = "ITN use"). After these steps, `nets` should contain 15 variables. [**Note:** When creating factor variables, **do not** use the `ordered=TRUE` option to create ordinal variables. No written response is required for this question. Display the code chunk(s) that perform the requested data management steps for this question.] 


```{r}
# creat 6 factor variables
nets <- mutate(nets,
               rural_factor = factor(rural,
                                     levels = c(0,1),
                                     labels = c("Urban", "Rural")),
               
               hcdist_factor = factor(hcdist,
                                      levels = c(1,2,3),
                                      labels = c("<15 miles", "15-50 miles", "50+ miles")),
               
               child_factor = factor(child,
                                     levels = c(0,1),
                                     labels = c("No","Yes")),
               
               wealth_factor = factor(wealth,
                                      levels = c(1,2,3,4),
                                      labels = c("Lowest quartile", "Second quartile","Third quartile","Highest quartile")),
               
               roof_factor = factor(roof,
                                    levels = c(0,1),
                                    labels = c("Corrugated metal", "Thatched")),
               
               net_factor = factor(net,
                                   levels = c(0,1),
                                   labels = c("No ITN use", "ITN use")))
```

```{r}
# check number of variables in dataset
ncol(nets)
```



**2.** The **research question** is: What characteristics are associated with ITN use in a household [`net`], where ITN use the previous night is the event of interest (i.e., `1`="success")?  By the end of this question, you will complete **Table 1**, giving a snapshot of the characteristics of the sample and each characteristic's unadjusted association with ITN use. 


**Table 1. Characteristics of the Sample and Unadjusted Associations with ITN Use**

**Used ITN the Previous Night**       | **Yes (N=384)**  | **No (N=1034)**  | **Unadjusted OR <br>(95% CI)^[Categorical variable comparisons relative to reference cateogry]** | **P-value^[From unadjusted logistic regression model]** |
--------------------------------------|:----------------:|:----------------:|:-----------------:|:----------------:|   
**Family size, mean (SD)**            | xx.xx (xx.xx)    | xx.xx (xx.xx)    | x.xx (x.xx, x.xx) | x.xxx            |
**Head of household age, mean (SD)**  | xx.xx (xx.xx)    | xx.xx (xx.xx)    | x.xx (x.xx, x.xx) | x.xxx            |
**Rural household, n (%)**            |                  |                  |                   |                  |
Rural                                 | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
Urban (ref)                           | xxx (xx.x%)      | xxx (xx.x%)      | -                 | -                |
**Distance to health care facility, n (%)** |            |                  |                   |                  |
50+ miles                             | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
15-50 miles                           | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
<15 miles (ref)                       | xxx (xx.x%)      | xxx (xx.x%)      | -                 | -                |
**Children under 5 in household, n (%)** |               |                  |                   |                  |
Yes                                   | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
No (ref)                              | xxx (xx.x%)      | xxx (xx.x%)      | -                 | -                |
**Household wealth index, n (%)**     |                  |                  |                   |                  |
Highest quartile                      | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
Third quartile                        | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
Second quartile                       | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
Lowest quartile (ref)                 | xxx (xx.x%)      | xxx (xx.x%)      | -                 | -                |
**Roof Type, n (%)**                  |                  |                  |                   |                  |
Thatched                              | xxx (xx.x%)      | xxx (xx.x%)      | x.xx (x.xx, x.xx) | x.xxx            |
Corrugated metal (ref)                | xxx (xx.x%)      | xxx (xx.x%)      | -                 | -                |


**a.** In this question, you will investigate the relationship between the **quantitative predictor variables** listed below and ITN use.  

*Quantitative predictor variables:*  

- Family size   
- Head of household age  

**(i).** <span style="color: #CC0000;">[6 points]</span> Report the mean and standard deviation of the quantitative variables by ITN use category. Fill in these values in **Table 1**. [**Note:** Other than filling in the requested information in **Table 1**, no written response is required for **(i)**. Display the code chunk(s) that perform the requested analyses and the **R** output.]  

```{r}
# mean and standard deviation of family size and head of household age
library(arsenal)

library(knitr)

my_labels <- list(famsize = "Family size, mean (SD)",
                  age = "Head of household age, mean (SD)",
                  net_factor = "Used ITN the Previous Night, mean (SD)")

my_controls <- tableby.control(numeric.stats = c("meansd"))

table1 <- tableby(net_factor ~ famsize + age,
                  data = nets,
                  control = my_controls
                  )


kable(summary(table1,
        labelTranslations = my_labels,
        title = "Table1. Characteristics of the Sample and Unadjusted Associations with ITN Use",
        term.name = TRUE))
```


**(ii).** <span style="color: #CC0000;">[10 points]</span> Run a logistic regression model for each quantitative predictor variable (i.e., *2 separate models*). For each model, estimate the unadjusted odds ratio of ITN use and the 95% confidence interval of the odds ratio. For each odds ratio, report the p-value from the Wald test of $H_0: OR=1$ vs. $H_1: OR \neq 1$. Fill in these values in **Table 1**. For your written response: Interpret each odds ratio and interpret the conclusion of the hypothesis test performed for each predictor variable analyzed in this question **in the context of this application**.

```{r}
# logistic regression for family size
mod.famsize <- glm(net ~ famsize, data = nets, family = binomial(link = "logit"))

summary(mod.famsize)
```
```{r}
# 95% confidence interval
confint.default(mod.famsize)
```

The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.famsize)[1],3)` `r ifelse(summary(mod.famsize)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.famsize)$coefficients[2]),3)` Family size. 

The unadjusted odds ratio is $\hat{OR} = e^{b} =$ `r round(exp(summary(mod.famsize)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.famsize)[2,1]),3)`, `r round(exp(confint.default(mod.famsize)[2,2]),3)`)], which means a 1-unit increase in family size increases the odds of ITN use by `r round(100*(exp(summary(mod.famsize)$coefficients[2])-1),3)`%.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly associated with family size (p-value `r ifelse(summary(mod.famsize)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.famsize)$coefficients[8],3)))`). 



```{r}
# logistic regression for head of household age
mod.age <- glm(net ~ age, data = nets, family = binomial(link = "logit"))

summary(mod.age)
```

The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.age)[1],3)` `r ifelse(summary(mod.age)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.age)$coefficients[2]),3)` Head of household age. 

The unadjusted odds ratio is $\hat{OR} = e^{b} =$ `r round(exp(summary(mod.age)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.age)[2,1]),3)`, `r round(exp(confint.default(mod.age)[2,2]),3)`)], which means a 1-unit increase in head of household age decreases the odds of ITN use by `r round(100*(1-exp(summary(mod.age)$coefficients[2])),3)`%.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly associated with head of household age (p-value `r ifelse(summary(mod.age)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.age)$coefficients[8],3)))`). 



**(iii).** <span style="color: #CC0000;">[10 points]</span> Using the appropriate simple logistic regression model, report the following fitted probabilities of ITN use:

-	Report the fitted probabilities of ITN use for households with family sizes of 2, 5, and 10

- Do the estimated probabilities increase or decrease as expected based on the odds ratios estimated in **(ii)**?  Explain.

```{r}
# family sizes of 2, 5, and 10 are in the range
range(nets$famsize, na.rm = TRUE)
```

```{r}
# values of x to estimate p
pred.x_famsize <- data.frame(famsize = c(2,5,10))

# returns fitted probabilities
phat <- predict(mod.famsize, newdata = pred.x_famsize, type = "response")

cbind(pred.x_famsize, phat)
```


- The estimated probability of ITN use for households with family sizes of 2 is equal to $\hat{p}=$ `r round(phat[1],3)`.

- The estimated probability of ITN use for households with family sizes of 5 is equal to $\hat{p}=$ `r round(phat[2],3)`.

- The estimated probability of ITN use for households with family sizes of 10 is equal to $\hat{p}=$ `r round(phat[3],3)`.

- The estimated probability of ITN use increases with households with family sizes. This is expected based on the estimated $\hat{OR} = $ `r round(exp(summary(mod.famsize)$coefficients[2]),3)` $>1$.



Report the fitted probabilities of ITN use for households where the age of the head of the household is 20, 40, and 60 years

Do the estimated probabilities increase or decrease as expected based on the odds ratios estimated in **(ii)**?  Explain.

```{r}
# age of the head of the household is 20, 40, and 60 years are in the range
range(nets$age, na.rm = TRUE)
```

```{r}
# values of x to estimate p
pred.x_age <- data.frame(age = c(20,40,60))

# returns fitted probabilities
phat <- predict(mod.age, newdata = pred.x_age, type = "response")

cbind(pred.x_age, phat)
```

- The estimated probability of ITN use for households where the age of the head of the household is 20 years is equal to $\hat{p}=$ `r round(phat[1],3)`.

- The estimated probability of ITN use for households where the age of the head of the household is 40 years is equal to $\hat{p}=$ `r round(phat[2],3)`.

- The estimated probability of ITN use for households where the age of the head of the household is 60 years is equal to $\hat{p}=$ `r round(phat[3],3)`.

- The estimated probability of ITN use decreases with households with family sizes. This is expected based on the estimated $\hat{OR} = $ `r round(exp(summary(mod.age)$coefficients[2]),3)` $<1$.




**b.** In this question, you will investigate the relationship between the **categorical predictor variables** listed below and ITN use.  

*Categorical predictor variables:*   

- Rural household indicator  
- Distance to health care facility  
- Presence of children under age of 5 years in household  
- Wealth index of household    
- Type of roof   

**(i).** <span style="color: #CC0000;">[10 points]</span> Report the frequency and relative frequency (%) of each level of the categorical variable by ITN use category. When reporting percentages, report **row percentages** (e.g., out of households in a rural setting, what percentage used the ITN the previous night). Fill in these values in **Table 1**. [**Note:** Other than filling in the requested information in **Table 1**, no written response is required for **(i)**. Display the code chunk(s) that perform the requested analyses and the **R** output.]  

```{r}
# frequency and relative frequency of categorical variable by ITN use category
my_labels <- list(rural_factor = "Rural household, n (%)",
                  hcdist_factor = "Distance to health care facility, n (%)",
                  child_factor = "Children under 5 in household, n (%)",
                  wealth_factor = "Household wealth index, n (%)",
                  roof_factor = "Roof Type, , n (%)")

my_controls <- tableby.control(cat.stats = c("countrowpct"))

tab2 <- tableby(net_factor ~ rural_factor + hcdist_factor + child_factor + wealth_factor + roof_factor,
                data = nets,
                control = my_controls)

kable(summary(tab2,
        labelTranslations = my_labels,
        title = "Table1. Characteristics of the Sample and Unadjusted Associations with ITN Use",
        term.name = TRUE))
```





**(ii).** <span style="color: #CC0000;">[25 points]</span>  Run a logistic regression model for each categorical predictor variable (i.e., *5 separate models*). For each model, estimate the unadjusted odds ratio(s) of ITN use and the 95% confidence interval of the odds ratio(s). [**Note:** Odds ratios should be computed assuming the reference levels specified in question **1**. Models containing categorical predictors with 3 or more levels will have more than one odds ratio]. For each odds ratio, report the p-value from the Wald test of $H_0: OR=1$ vs. $H_1: OR \neq 1$. Fill in these values in **Table 1**. For your written response: Interpret each odds ratio and interpret the conclusion of the hypothesis test performed for each odds ratio **in the context of this application**.

- Rural household indicator 

```{r}
# check dummy variable coding
contrasts(nets$rural_factor)
```

```{r}
mod.rural <- glm(net ~ rural_factor, data = nets,
                 family = binomial(link = "logit"))

summary(mod.rural)
```


The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.rural)[1],3)` `r ifelse(summary(mod.rural)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.rural)$coefficients[2]),3)` Rural.


The unadjusted odds ratio is $\hat{OR} = e^{b} =$ `r round(exp(summary(mod.rural)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.rural)[2,1]),3)`, `r round(exp(confint.default(mod.rural)[2,2]),3)`)], which means the odds of ITN use is `r round(100*(exp(summary(mod.rural)$coefficients[2])-1),3)`% higher in households in rural compared to households in urban.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly different in rural and urban (p-value `r ifelse(summary(mod.rural)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.rural)$coefficients[8],3)))`). 


- Distance to health care facility 


```{r}
# check dummy variable coding
contrasts(nets$hcdist_factor)
```

```{r}
mod.hcdist <- glm(net ~ hcdist_factor, data = nets,
                 family = binomial(link = "logit"))

summary(mod.hcdist)
```


The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.hcdist)[1],3)` `r ifelse(summary(mod.hcdist)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.hcdist)$coefficients[2]),3)` 15-50 miles `r ifelse(summary(mod.hcdist)$coefficients[3]<0,"$-$","$+$")` `r round(abs(summary(mod.hcdist)$coefficients[3]),3)` 50+ miles.


The unadjusted odds ratio of the first dummy variable 15-50 miles is $\hat{OR} = e^{b_1} =$ `r round(exp(summary(mod.hcdist)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.hcdist)[2,1]),3)`, `r round(exp(confint.default(mod.hcdist)[2,2]),3)`)], which means the odds of ITN use is `r round(100*(1-exp(summary(mod.hcdist)$coefficients[2])),3)`% lower in household located 15-50 miles from health care facility compared to household located <15 miles.

We fail to reject $H_0$ of the Wald test and can't conclude that the odds of ITN use is significantly different in household located 15-50 miles from health care facility and household located <15 miles (p-value `r ifelse(summary(mod.hcdist)$coefficients[11]<.001,"<.001",paste("=",round(summary(mod.hcdist)$coefficients[11],3)))`). 


The unadjusted odds ratio of the second dummy variable 50+ miles is $\hat{OR} = e^{b_2} =$ `r round(exp(summary(mod.hcdist)$coefficients[3]),3)` [95% CI (`r round(exp(confint.default(mod.hcdist)[3,1]),3)`, `r round(exp(confint.default(mod.hcdist)[3,2]),3)`)], which means the odds of ITN use is `r round(100*(1-exp(summary(mod.hcdist)$coefficients[3])),3)`% lower in household located 50+ miles from health care facility compared to household located <15 miles.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly different in household located 50+ miles from health care facility and household located <15 miles (p-value `r ifelse(summary(mod.hcdist)$coefficients[12]<.001,"<.001",paste("=",round(summary(mod.hcdist)$coefficients[12],3)))`). 



- Presence of children under age of 5 years in household  


```{r}
# check dummy variable coding
contrasts(nets$child_factor)
```

```{r}
mod.child <- glm(net ~ child_factor, data = nets,
                 family = binomial(link = "logit"))

summary(mod.child)
```


The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.child)[1],3)` `r ifelse(summary(mod.child)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.child)$coefficients[2]),3)` Children.


The unadjusted odds ratio is $\hat{OR} = e^{b} =$ `r round(exp(summary(mod.child)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.child)[2,1]),3)`, `r round(exp(confint.default(mod.child)[2,2]),3)`)], which means the odds of ITN use is `r round(100*(exp(summary(mod.child)$coefficients[2])-1),3)`% higher in households which have children under the age of 5 years compared to households which not.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly different in households which have children under the age of 5 years and households which not (p-value `r ifelse(summary(mod.child)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.child)$coefficients[8],3)))`). 


- Wealth index of household 


```{r}
# check dummy variable coding
contrasts(nets$wealth_factor)
```

```{r}
mod.wealth <- glm(net ~ wealth_factor, data = nets,
                 family = binomial(link = "logit"))

summary(mod.wealth)
```


The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.wealth)[1],3)` `r ifelse(summary(mod.wealth)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.wealth)$coefficients[2]),3)` Second quartile `r ifelse(summary(mod.wealth)$coefficients[3]<0,"$-$","$+$")` `r round(abs(summary(mod.wealth)$coefficients[3]),3)` Third quartile `r ifelse(summary(mod.wealth)$coefficients[4]<0,"$-$","$+$")` `r round(abs(summary(mod.wealth)$coefficients[4]),3)` Highest quartile.


The unadjusted odds ratio of the first dummy variable Second quartile is $\hat{OR} = e^{b_1} =$ `r round(exp(summary(mod.wealth)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.wealth)[2,1]),3)`, `r round(exp(confint.default(mod.wealth)[2,2]),3)`)], which means the odds of ITN use is `r round(100*(exp(summary(mod.wealth)$coefficients[2])-1),3)`% higher in household within the second quartile of wealth index compared to household within the lowest quartile of wealth index.

We fail to reject $H_0$ of the Wald test and can't conclude that the odds of ITN use is significantly different in household within the second quartile of wealth index and household within the lowest quartile of wealth index (p-value `r ifelse(summary(mod.wealth)$coefficients[14]<.001,"<.001",paste("=",round(summary(mod.wealth)$coefficients[14],3)))`). 


The unadjusted odds ratio of the second dummy variable Third quartile is $\hat{OR} = e^{b_2} =$ `r round(exp(summary(mod.wealth)$coefficients[3]),3)` [95% CI (`r round(exp(confint.default(mod.wealth)[3,1]),3)`, `r round(exp(confint.default(mod.wealth)[3,2]),3)`)], which means the odds of ITN use is `r round(100*(exp(summary(mod.wealth)$coefficients[3])-1),3)`% higher in household within the third quartile of wealth index compared to household within the lowest quartile of wealth index.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly different in household within the second quartile of wealth index and household within the lowest quartile of wealth index. (p-value `r ifelse(summary(mod.wealth)$coefficients[15]<.001,"<.001",paste("=",round(summary(mod.wealth)$coefficients[15],3)))`).


The unadjusted odds ratio of the third dummy variable Highest quartile is $\hat{OR} = e^{b_3} =$ `r round(exp(summary(mod.wealth)$coefficients[4]),3)` [95% CI (`r round(exp(confint.default(mod.wealth)[4,1]),3)`, `r round(exp(confint.default(mod.wealth)[4,2]),3)`)], which means the odds of ITN use is `r round(100*(exp(summary(mod.wealth)$coefficients[4])-1),3)`% higher in household within the highest quartile of wealth index compared to household within the lowest quartile of wealth index.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly different in household within the highest quartile of wealth index and household within the lowest quartile of wealth index. (p-value `r ifelse(summary(mod.wealth)$coefficients[16]<.001,"<.001",paste("=",round(summary(mod.wealth)$coefficients[16],3)))`).


- Type of roof 

```{r}
# check dummy variable coding
contrasts(nets$roof_factor)
```

```{r}
mod.roof<- glm(net ~ roof_factor, data = nets,
                 family = binomial(link = "logit"))

summary(mod.roof)
```


The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.roof)[1],3)` `r ifelse(summary(mod.roof)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.roof)$coefficients[2]),3)` Thatched.


The unadjusted odds ratio is $\hat{OR} = e^{b} =$ `r round(exp(summary(mod.roof)$coefficients[2]),3)` [95% CI (`r round(exp(confint.default(mod.roof)[2,1]),3)`, `r round(exp(confint.default(mod.roof)[2,2]),3)`)], which means the odds of ITN use is `r round(100*(exp(summary(mod.roof)$coefficients[2])-1),3)`% higher in households which have thatched roof compared to households which have corrugated metal roof.

We reject $H_0$ of the Wald test and conclude that the odds of ITN use is significantly different in households which have thatched roof and households which have corrugated metal roof (p-value `r ifelse(summary(mod.roof)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.roof)$coefficients[8],3)))`). 

**3.** The **research question** would like to investigate the effect of each predictor variable while controlling or adjusting for the other predictors. 

**a.** <span style="color: #CC0000;">[4 points]</span> Build a multiple logistic regression model that includes the variables: (1) family size, (2) age of head of household, (3) living in a rural area, (4) distance to health care facility, (5) having a child under age 5, (6) wealth index and (7) roof type.  Except for family size and age, which are continuous variables, the other predictor variables in the model should be treated as categorical variables and their factor versions should be included in the model using the reference levels specified in question **1**. Report the fitted multiple logistic regression model. 

```{r}
mod.mul <- glm(net ~ famsize + age + rural_factor + hcdist_factor + child_factor + wealth_factor + roof_factor,
               data = nets,
               family = binomial(link = "logit"))

summary(mod.mul)
```

- The fitted model is $\log \left(\frac{\hat{p}}{1-\hat{p}}\right) =$ `r round(coef(mod.mul)[1],4)` `r ifelse(summary(mod.mul)$coefficients[2]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[2]),3)` Family size `r ifelse(summary(mod.mul)$coefficients[3]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[3]),3)` Age `r ifelse(summary(mod.mul)$coefficients[4]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[4]),3)` Rural `r ifelse(summary(mod.mul)$coefficients[5]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[5]),3)` 15-50 miles `r ifelse(summary(mod.mul)$coefficients[6]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[6]),3)` 50+ miles `r ifelse(summary(mod.mul)$coefficients[7]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[7]),3)` Children   `r ifelse(summary(mod.mul)$coefficients[8]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[8]),3)` Second quartile `r ifelse(summary(mod.mul)$coefficients[9]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[9]),3)` Third quartile `r ifelse(summary(mod.mul)$coefficients[10]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[10]),3)` Highest quartile `r ifelse(summary(mod.mul)$coefficients[11]<0,"$-$","$+$")` `r round(abs(summary(mod.mul)$coefficients[11]),3)` Thatched.


**b.** <span style="color: #CC0000;">[5 points]</span> Report the fitted probability of ITN use for households of size 5, with a head of household that is 50 years of age, without children under the age of 5, in the second quartile of wealth, and assume the house has a thatched roof, is in a rural setting, and is 30 miles from the nearest health care facility. 

```{r}
# values of x used to estimate p
pred.x <- data.frame(famsize = 5, age = 50, rural_factor = "Rural", hcdist_factor = "15-50 miles", child_factor = "No", wealth_factor = "Second quartile", roof_factor = "Thatched")

# return the predicted probability
phat <-predict(mod.mul, newdata = pred.x, type = "response")
cbind(pred.x, phat)
```

The fitted probability is `r round(phat[1],3)`.

**c.** <span style="color: #CC0000;">[4 points]</span> Interpret the odds ratio associated with family size in the multiple logistic regression model. Is family size significantly associated with ITN use, adjusted for all the other variables included in the model? If you were volunteering in Africa with an organization that wanted to increase ITN utilization, which households would you approach first: smaller sized households or larger sized households?

While controlling for the other predictors, the odds ratio associated with family size is $\hat{OR} = e^{b_1} =$ `r round(exp(summary(mod.mul)$coefficients[2]),2)` [95% CI (`r round(exp(confint.default(mod.mul)[2,1]),2)`, `r round(exp(confint.default(mod.mul)[2,2]),2)`)], which means 1-unit increase in family size increases the odds of ITN use by `r round(100*(exp(summary(mod.mul)$coefficients[2])-1),3)`%. I would approach smaller sized households first because smaller sized households have a lower odds of ITN use compared to larger sized households.


**d.** <span style="color: #CC0000;">[6 points]</span> Interpret the odds ratios associated with the distance to health care facility dummy variables in the multiple logistic regression model. As a volunteer, which households would you approach first: households closer to health care facilities or households further away?


While controlling for the other predictors, the odds ratio associated with the first dummy variable 15-50 miles of distance to health care facility is $\hat{OR} = e^{b_4} =$ `r round(exp(summary(mod.mul)$coefficients[5]),3)` [95% CI (`r round(exp(confint.default(mod.mul)[5,1]),3)`, `r round(exp(confint.default(mod.mul)[5,2]),3)`)]. The odds of ITN use is `r round(100*(1-exp(summary(mod.mul)$coefficients[5])),3)`% lower in households 15-50 miles from the nearest health care facility compared to households <15 miles from the nearest health care facility. While controlling for the other predictors, the odds ratio associated with the second dummy variable 50+ miles of distance to health care facility is $\hat{OR} = e^{b_5} =$ `r round(exp(summary(mod.mul)$coefficients[6]),3)` [95% CI (`r round(exp(confint.default(mod.mul)[6,1]),3)`, `r round(exp(confint.default(mod.mul)[6,2]),3)`)]. The odds of ITN use is `r round(100*(1-exp(summary(mod.mul)$coefficients[6])),3)`% lower in households >50 miles from the nearest health care facility compared to households <15 miles from the nearest health care facility. I would approach households further away to health care facilities first because smaller they have a lower odds of ITN use compared to households closer to health care facilities.


**e.** <span style="color: #CC0000;">[10 points]</span> Perform a likelihood ratio test to determine if distance to health care facility is an overall important predictor in the multiple regression model. (i) State the null and alternative hypotheses; (ii) From your **R** output, report the value of the test statistic and p-value; (iii) State your statistical conclusion and your conclusion in the context of the problem. 

```{r}
# reduced model
mod.red <- glm(net ~ famsize + age + rural_factor + child_factor + wealth_factor + roof_factor,
               data = nets,
               family = binomial(link = "logit"))

# LRT comparing full and reduced models
anova(mod.red, mod.mul, test = "Chisq")

```



 (i) State the null and alternative hypotheses; 
 
 $H_0: \beta_4 = \beta_5 = 0$ vs. $H_1: \beta_4,\beta_5$ not all 0.
 
 (ii) From your **R** output, report the value of the test statistic and p-value;
 
 Test statistic G = `r round(anova(mod.red, mod.mul, test = "Chisq")$"Deviance"[2],3)` and p-value `r ifelse(anova(mod.red, mod.mul, test="Chisq")$"Pr(>Chi)"[2]<.001,"<.001",paste("=",round(anova(mod.red, mod.mul, test="Chisq")$"Pr(>Chi)"[2],3)))`.

 
 (iii) State your statistical conclusion and your conclusion in the context of the problem.  
 
We have evidence to reject $H_0$ and conclude that at least one $\beta_4$ or $\beta_5$ is not equal to 0. The overall effect of distance to health care facility is statistically significant in the full model that controls for other predictors.

**f.** <span style="color: #CC0000;">[5 points]</span> In a few sentences, summarize your findings. In particular, list which factors are associated with an increased odds of ITN utilization and which factors are associated with a decreased odds of ITN utilization based on the adjusted odds ratios estimated in your multiple logistic regression model.  

Based on the adjusted odds ratios estimated in your multiple logistic regression model, larger family size, smaller age of a head of household, household in a rural setting, households closer to health care facilities, household with children under the age of 5, household with higher wealth index and household has a thatched roof are associated with an increased odds of ITN utilization. In contrast, smaller family size, larger age of a head of household, household in a urban setting, households further from health care facilities, household without children under the age of 5, household with lower wealth index and household has a corrugated metal roof are associated with a decreased odds of ITN utilization.








**Table 1. Characteristics of the Sample and Unadjusted Associations with ITN Use**

**Used ITN the Previous Night**       | **Yes (N=384)**  | **No (N=1034)**  | **Unadjusted OR <br>(95% CI)^[Categorical variable comparisons relative to reference cateogry]** | **P-value^[From unadjusted logistic regression model]** |
--------------------------------------|:----------------:|:----------------:|:-----------------:|:----------------:|   
**Family size, mean (SD)**            |  `r round(by(nets$famsize, nets$net_factor, mean, na.rm=TRUE)[2] ,2)`(`r round(by(nets$famsize, nets$net_factor, sd, na.rm=TRUE)[2] ,2)`)    | `r round(by(nets$famsize, nets$net_factor, mean, na.rm=TRUE)[1] ,2)` (`r round(by(nets$famsize, nets$net_factor, mean, na.rm=TRUE)[1] ,2)`)    | `r round(exp(summary(mod.famsize)$coefficients[2]),2)` (`r round(exp(confint.default(mod.famsize)[2,1]),2)`, `r round(exp(confint.default(mod.famsize)[2,2]),2)`) | `r ifelse(summary(mod.famsize)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.famsize)$coefficients[8],3)))`            |
**Head of household age, mean (SD)**  | `r round(by(nets$age, nets$net_factor, mean, na.rm=TRUE)[2] ,2)`(`r round(by(nets$age, nets$net_factor, sd, na.rm=TRUE)[2] ,2)`)    | `r round(by(nets$age, nets$net_factor, mean, na.rm=TRUE)[1] ,2)`(`r round(by(nets$age, nets$net_factor, sd, na.rm=TRUE)[1] ,2)`)    | `r round(exp(summary(mod.age)$coefficients[2]),2)` (`r round(exp(confint.default(mod.age)[2,1]),2)`, `r round(exp(confint.default(mod.age)[2,2]),2)`) | `r ifelse(summary(mod.age)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.age)$coefficients[8],3)))`           |
**Rural household, n (%)**            |                  |                  |                   |                  |
Rural                                 | `r table(nets$rural_factor, nets$net_factor)[2,2]` (`r round(100*prop.table(table(nets$rural_factor, nets$net_factor)),1)[2,2]`%)      | `r table(nets$rural_factor, nets$net_factor)[2,1]` (`r round(100*prop.table(table(nets$rural_factor, nets$net_factor)),1)[2,1]`%)      | `r round(exp(summary(mod.rural)$coefficients[2]),2)` (`r round(exp(confint.default(mod.rural)[2,1]),2)`, `r round(exp(confint.default(mod.rural)[2,2]),2)`) | `r ifelse(summary(mod.rural)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.rural)$coefficients[8],3)))`            |
Urban (ref)                           | `r table(nets$rural_factor, nets$net_factor)[1,2]` (`r round(100*prop.table(table(nets$rural_factor, nets$net_factor)),1)[1,2]`%)      | `r table(nets$rural_factor, nets$net_factor)[1,1]` (`r round(100*prop.table(table(nets$rural_factor, nets$net_factor)),1)[1,1]`%)      | -                 | -                |
**Distance to health care facility, n (%)** |            |                  |                   |                  |
50+ miles                             | `r table(nets$hcdist_factor, nets$net_factor)[3,2]` (`r round(100*prop.table(table(nets$hcdist_factor, nets$net_factor)),1)[3,2]`%)      | `r table(nets$hcdist_factor, nets$net_factor)[3,1]` (`r round(100*prop.table(table(nets$hcdist_factor, nets$net_factor)),1)[3,1]`%)      | `r round(exp(summary(mod.hcdist)$coefficients[3]),2)` (`r round(exp(confint.default(mod.hcdist)[3,1]),2)`, `r round(exp(confint.default(mod.hcdist)[3,2]),2)`) | `r ifelse(summary(mod.hcdist)$coefficients[12]<.001,"<.001",paste("=",round(summary(mod.hcdist)$coefficients[12],3)))`            |
15-50 miles                           | `r table(nets$hcdist_factor, nets$net_factor)[2,2]` (`r round(100*prop.table(table(nets$hcdist_factor, nets$net_factor)),1)[2,2]`%)      | `r table(nets$hcdist_factor, nets$net_factor)[2,1]` (`r round(100*prop.table(table(nets$hcdist_factor, nets$net_factor)),1)[2,1]`%)      | `r round(exp(summary(mod.hcdist)$coefficients[2]),2)` (`r round(exp(confint.default(mod.hcdist)[2,1]),2)`, `r round(exp(confint.default(mod.hcdist)[2,2]),2)` | `r ifelse(summary(mod.hcdist)$coefficients[11]<.001,"<.001",round(summary(mod.hcdist)$coefficients[11],3))`            |
<15 miles (ref)                       | `r table(nets$hcdist_factor, nets$net_factor)[1,2]` (`r round(100*prop.table(table(nets$hcdist_factor, nets$net_factor)),1)[1,2]`%)      | `r table(nets$hcdist_factor, nets$net_factor)[1,1]` (`r round(100*prop.table(table(nets$hcdist_factor, nets$net_factor)),1)[1,1]`%)      | -                 | -                |
**Children under 5 in household, n (%)** |               |                  |                   |                  |
Yes                                   | `r table(nets$child_factor, nets$net_factor)[2,2]` (`r round(100*prop.table(table(nets$child_factor, nets$net_factor)),1)[2,2]`%)      | `r table(nets$child_factor, nets$net_factor)[2,1]` (`r round(100*prop.table(table(nets$child_factor, nets$net_factor)),1)[2,1]`%)      | `r round(exp(summary(mod.child)$coefficients[2]),3)` (`r round(exp(confint.default(mod.child)[2,1]),3)`, `r round(exp(confint.default(mod.child)[2,2]),3)`) | `r ifelse(summary(mod.child)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.child)$coefficients[8],3)))`            |
No (ref)                              | `r table(nets$child_factor, nets$net_factor)[1,2]` (`r round(100*prop.table(table(nets$child_factor, nets$net_factor)),1)[1,2]`%)      | `r table(nets$child_factor, nets$net_factor)[1,1]` (`r round(100*prop.table(table(nets$child_factor, nets$net_factor)),1)[1,1]`%)      | -                 | -                |
**Household wealth index, n (%)**     |                  |                  |                   |                  |
Highest quartile                      | `r table(nets$wealth_factor, nets$net_factor)[4,2]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[4,2]`%)      | `r table(nets$wealth_factor, nets$net_factor)[4,1]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[4,1]`%)      | `r round(exp(summary(mod.wealth)$coefficients[4]),2)` (`r round(exp(confint.default(mod.wealth)[4,1]),2)`, `r round(exp(confint.default(mod.wealth)[4,2]),2)`) | `r ifelse(summary(mod.wealth)$coefficients[16]<.001,"<.001",paste("=",round(summary(mod.wealth)$coefficients[16],3)))`            |
Third quartile                        | `r table(nets$wealth_factor, nets$net_factor)[3,2]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[3,2]`%)      | `r table(nets$wealth_factor, nets$net_factor)[3,1]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[3,1]`%)      | `r round(exp(summary(mod.wealth)$coefficients[3]),2)` (`r round(exp(confint.default(mod.wealth)[3,1]),2)`, `r round(exp(confint.default(mod.wealth)[3,2]),2)`) | `r ifelse(summary(mod.wealth)$coefficients[15]<.001,"<.001",paste("=",round(summary(mod.wealth)$coefficients[15],3)))`            |
Second quartile                       | `r table(nets$wealth_factor, nets$net_factor)[2,2]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[2,2]`%)      | `r table(nets$wealth_factor, nets$net_factor)[2,1]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[2,1]`%)      | `r round(exp(summary(mod.wealth)$coefficients[2]),2)` (`r round(exp(confint.default(mod.wealth)[2,1]),2)`, `r round(exp(confint.default(mod.wealth)[2,2]),2)`) | `r ifelse(summary(mod.wealth)$coefficients[14]<.001,"<.001",round(summary(mod.wealth)$coefficients[14],3))`            |
Lowest quartile (ref)                 | `r table(nets$wealth_factor, nets$net_factor)[1,2]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[1,2]`%)      | `r table(nets$wealth_factor, nets$net_factor)[1,1]` (`r round(100*prop.table(table(nets$wealth_factor, nets$net_factor)),1)[1,1]`%)      | -                 | -                |
**Roof Type, n (%)**                  |                  |                  |                   |                  |
Thatched                              | `r table(nets$roof_factor, nets$net_factor)[2,2]` (`r round(100*prop.table(table(nets$roof_factor, nets$net_factor)),1)[2,2]`%)      | `r table(nets$roof_factor, nets$net_factor)[2,1]` (`r round(100*prop.table(table(nets$roof_factor, nets$net_factor)),1)[2,1]`%)      | `r round(exp(summary(mod.roof)$coefficients[2]),2)` (`r round(exp(confint.default(mod.roof)[2,1]),2)`, `r round(exp(confint.default(mod.roof)[2,2]),2)`) | `r ifelse(summary(mod.roof)$coefficients[8]<.001,"<.001",paste("=",round(summary(mod.roof)$coefficients[8],3)))`            |
Corrugated metal (ref)                | `r table(nets$roof_factor, nets$net_factor)[1,2]` (`r round(100*prop.table(table(nets$roof_factor, nets$net_factor)),1)[1,2]`%)      | `r table(nets$roof_factor, nets$net_factor)[1,1]` (`r round(100*prop.table(table(nets$roof_factor, nets$net_factor)),1)[1,1]`%)      | -                 | -                |




